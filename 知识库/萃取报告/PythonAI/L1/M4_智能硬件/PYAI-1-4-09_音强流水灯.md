# [PYAI-1-4-09] 音强流水灯

> **模块**：L1-M4 智能硬件
> **认知负荷**：中-高
> **核心技能**：NeoPixel灯带、声音传感器、流水灯算法
> **UID**：PYAI-14-09-001

---

## 课程基本信息

| 项目 | 内容 |
|------|------|
| **课程编号** | PYAI-1-4-09 |
| **课程名称** | 音强流水灯 |
| **认知负荷** | 中-高 |
| **核心技能** | NeoPixel灯带、声音传感器、流水灯算法 |
| **课时** | 90分钟 |

---

## 详细教学流程

### 步骤1：课程导入（5分钟）

`#低负荷-热身` `#IFC-预防`

**教师话术**
> "同学们见过KTV里跟着音乐闪烁的灯光吗？今天我们来做一个**音乐律动灯**——灯光会随着声音的强弱变化！"

---

### 步骤2：知识讲解（15分钟）

`#中负荷-操练` `#IFC-即时`

**教师话术**
> "**NeoPixel灯带**：可以单独控制每颗LED的颜色
>
> ```python
> import neopixel
> from machine import Pin
>
> NUM_LEDS = 30  # 灯珠数量
> np = neopixel.NeoPixel(Pin(4), NUM_LEDS)
>
> # 设置第一颗灯为红色
> np[0] = (255, 0, 0)  # (R, G, B)
> np.write()  # 更新显示
> ```
>
> **声音传感器**：检测环境音量
> ```python
> from machine import Pin, ADC
>
> mic = ADC(Pin(34))
> mic.atten(ADC.ATTN_11DB)  # 设置量程
>
> sound_level = mic.read()  # 读取音量值（0-4095）
> ```
>
> **流水灯算法**：让颜色像水一样流动
> ```python
> # 核心思想：列表元素向右偏移
> colors = [(255,0,0), (0,255,0), (0,0,255), ...]
>
> # 每次循环，最后一个颜色移到最前面
> last_color = colors.pop()  # 取出最后一个
> colors.insert(0, last_color)  # 插入到最前面
> ```"

**核心代码模式**

```python
import neopixel
import time
from machine import Pin, ADC

# 初始化
NUM_LEDS = 30
np = neopixel.NeoPixel(Pin(4), NUM_LEDS)
mic = ADC(Pin(34))
mic.atten(ADC.ATTN_11DB)

# 初始化颜色列表（渐变色）
colors = []
for i in range(NUM_LEDS):
    # 生成彩虹渐变
    hue = int(i * 255 / NUM_LEDS)
    colors.append((hue, 255 - hue, 128))

while True:
    # 读取音量
    sound = mic.read()

    # 根据音量调整亮度
    brightness = min(255, sound // 16)

    # 应用颜色到灯带
    for i in range(NUM_LEDS):
        r = colors[i][0] * brightness // 255
        g = colors[i][1] * brightness // 255
        b = colors[i][2] * brightness // 255
        np[i] = (r, g, b)
    np.write()

    # 流水效果：颜色向右移动
    last = colors.pop()
    colors.insert(0, last)

    time.sleep_ms(50)
```

**变体示例**

| 学生情况 | 调整方案 | 说明 |
|----------|----------|------|
| 灯带不亮 | 检查供电 | NeoPixel需要5V供电，电流较大 |
| 音量检测不灵敏 | 调整阈值 | 根据环境噪音调整基准值 |
| 想要不同效果 | 修改算法 | 可以做呼吸灯、闪烁、追逐等效果 |

---

### 步骤3：硬件搭建（20分钟）

`#高负荷-产出` `#IFC-即时`

**教师话术**
> "今天的硬件：
>
> **NeoPixel灯带接线**：
> ```
> VCC → 5V（外部电源，不要用ESP32的5V）
> GND → GND（与ESP32共地）
> DIN → P4（数据输入）
> ```
>
> **声音传感器接线**：
> ```
> VCC → 3.3V
> GND → GND
> AO  → P34（模拟输出）
> ```
>
> **重要**：灯带耗电大，30颗灯全亮可能需要1.8A电流，必须用外部电源！"

**禁忌提醒**

❌ **灯带直接接ESP32的5V**——电流不够，可能烧毁USB口
❌ **忘记共地**——灯带和ESP32的GND必须连接
❌ **数据线接错**——DIN是输入，DOUT是输出（级联用）

---

### 步骤4：编程调试（30分钟）

`#高负荷-产出` `#IFC-即时`

**教师话术**
> "调试步骤：
>
> 1. **先测试灯带**：
>    ```python
>    # 让所有灯亮红色
>    for i in range(NUM_LEDS):
>        np[i] = (255, 0, 0)
>    np.write()
>    ```
>
> 2. **再测试声音传感器**：
>    ```python
>    while True:
>        print(mic.read())
>        time.sleep_ms(100)
>    ```
>    对着传感器说话，观察数值变化
>
> 3. **最后联调**：
>    - 安静时灯光暗
>    - 声音大时灯光亮
>    - 颜色在流动"

**变体示例**

| 学生情况 | 调整方案 | 说明 |
|----------|----------|------|
| 灯光闪烁不稳定 | 添加平滑处理 | 用移动平均值平滑音量数据 |
| 想做音乐节奏灯 | 检测节拍 | 检测音量的突变作为节拍 |
| 想控制更多灯 | 级联灯带 | 多条灯带可以串联 |

---

### 步骤5：成果展示（10分钟）

`#低负荷-热身` `#IFC-复盘`

**教师话术**
> "谁的音乐律动灯做好了？放一首歌试试效果！
>
> 思考：如何让灯光效果更炫酷？
> - 不同音量对应不同颜色
> - 低音和高音分开显示
> - 添加闪烁效果"

---

## 核心知识点

- NeoPixel灯带：可单独控制每颗LED颜色
- 声音传感器：ADC读取模拟音量值
- 流水灯算法：列表元素循环移位
- 亮度映射：音量值映射到亮度

---

## 底层逻辑

- **数据驱动显示**：传感器数据 → 视觉效果
- **列表操作**：pop()和insert()实现循环移位

---

`#执行层` `#测评项`
[UID: PYAI-14-09-001]

---

[上一课](PYAI-1-4-08_智能门禁3.md) | [返回模块](_模块概览.md) | [下一课](PYAI-1-4-10_智能花房1.md)
