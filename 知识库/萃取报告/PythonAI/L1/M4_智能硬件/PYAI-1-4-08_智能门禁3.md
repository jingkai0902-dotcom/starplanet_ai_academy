# [PYAI-1-4-08] 智能门禁(3) - 刷脸开门

> **模块**：L1-M4 智能硬件
> **认知负荷**：高
> **核心技能**：舵机控制Servo、系统集成
> **UID**：PYAI-14-08-001

---

## 课程基本信息

| 项目 | 内容 |
|------|------|
| **课程编号** | PYAI-1-4-08 |
| **课程名称** | 智能门禁(3) - 刷脸开门 |
| **认知负荷** | 高 |
| **核心技能** | 舵机控制Servo、系统集成 |
| **课时** | 90分钟 |
| **系列** | 智能门禁三部曲（3/3） |

---

## 详细教学流程

### 步骤1：课程回顾（5分钟）

`#低负荷-热身` `#IFC-预防`

**教师话术**
> "前两节课我们学会了摄像头采集和人脸比对。今天是最后一步——把AI和硬件连接起来，实现真正的刷脸开门！"

---

### 步骤2：知识讲解（15分钟）

`#中负荷-操练` `#IFC-即时`

**教师话术**
> "**舵机**是一种可以精确控制角度的电机：
>
> - 控制范围：0-180度
> - 用于：门锁、机械臂、云台等
>
> **舵机控制原理**：
> ```python
> from mpython import *
>
> # 舵机连接到P0引脚
> servo = Servo(Pin.P0)
>
> # 控制角度
> servo.write_angle(0)    # 转到0度（关门）
> servo.write_angle(90)   # 转到90度（开门）
> servo.write_angle(180)  # 转到180度
> ```
>
> **系统集成流程**：
> ```
> 摄像头采集 → 人脸比对 → 相似度判断 → 舵机控制
>      ↓            ↓           ↓           ↓
>    frame      similarity   > 0.8?     开门/拒绝
> ```"

**核心代码模式**

```python
import cv2
from mpython import *
import time

# 初始化舵机
servo = Servo(Pin.P0)
servo.write_angle(0)  # 初始位置（关门）

# 加载人脸模板
template = cv2.imread('my_face.jpg', cv2.IMREAD_GRAYSCALE)
template = cv2.resize(template, (100, 100))

# 打开摄像头
cap = cv2.VideoCapture(0)

# 匹配阈值
THRESHOLD = 0.8

while True:
    ret, frame = cap.read()
    if not ret:
        break

    # 转灰度并调整大小
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    gray_resized = cv2.resize(gray, (100, 100))

    # 计算相似度
    result = cv2.matchTemplate(gray_resized, template, cv2.TM_CCOEFF_NORMED)
    similarity = result[0][0]

    # 判断并控制舵机
    if similarity > THRESHOLD:
        print(f'匹配成功！相似度: {similarity:.2f}')
        servo.write_angle(90)  # 开门
        rgb.fill((0, 255, 0))  # 绿灯
        rgb.write()
        time.sleep(3)          # 保持3秒
        servo.write_angle(0)   # 关门
        rgb.fill((0, 0, 0))
        rgb.write()
    else:
        rgb.fill((255, 0, 0))  # 红灯
        rgb.write()

    # 显示画面
    cv2.imshow('Smart Door', frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
```

**变体示例**

| 学生情况 | 调整方案 | 说明 |
|----------|----------|------|
| 舵机不动 | 检查接线 | 确认信号线接到正确引脚 |
| 开门角度不对 | 调整角度值 | 根据实际门锁调整 |
| 想加密码备用 | 添加按键输入 | 人脸失败时可输入密码 |

---

### 步骤3：硬件搭建（20分钟）

`#高负荷-产出` `#IFC-即时`

**教师话术**
> "今天的硬件连接：
>
> **舵机接线**：
> ```
> 红线（VCC）→ 5V
> 棕线（GND）→ GND
> 橙线（信号）→ P0
> ```
>
> **注意事项**：
> - 舵机需要5V供电，3.3V可能力量不足
> - 不要强行扭动舵机摆臂
> - 角度范围通常是0-180度
>
> **门锁模型**：
> - 可以用纸板做一个简易门模型
> - 舵机摆臂连接门闩
> - 90度开门，0度关门"

**禁忌提醒**

❌ **强行扭动舵机**——会损坏内部齿轮
❌ **舵机角度超范围**——通常是0-180度，超出会卡死
❌ **忘记初始化位置**——程序开始时先设置初始角度

---

### 步骤4：系统联调（30分钟）

`#高负荷-产出` `#IFC-即时`

**教师话术**
> "现在进行完整系统测试：
>
> **测试步骤**：
> 1. 先测试舵机单独工作
> 2. 再测试摄像头和人脸比对
> 3. 最后联调整个系统
>
> **调试技巧**：
> ```python
> # 单独测试舵机
> servo.write_angle(0)
> time.sleep(1)
> servo.write_angle(90)
> time.sleep(1)
> servo.write_angle(0)
> ```
>
> **常见问题**：
> - 舵机抖动：可能是供电不足
> - 识别不准：调整阈值或重拍模板
> - 反应慢：减少图像处理的分辨率"

**变体示例**

| 学生情况 | 调整方案 | 说明 |
|----------|----------|------|
| 系统反应慢 | 降低分辨率 | 用更小的图像进行比对 |
| 想加语音提示 | 使用蜂鸣器 | 匹配成功时发出提示音 |
| 想记录访客 | 保存照片 | 每次识别时保存当前帧 |

---

### 步骤5：成果展示（10分钟）

`#低负荷-热身` `#IFC-复盘`

**教师话术**
> "谁的智能门禁做好了？演示一下刷脸开门！
>
> **思考**：
> - 这个系统还有什么可以改进的地方？
> - 真正的人脸识别系统是怎么做的？
> - 如何防止用照片欺骗系统？"

---

## 核心知识点

- 舵机控制：`Servo(pin).write_angle(angle)`
- 系统集成：AI判断 + 硬件控制
- 完整流程：采集 → 处理 → 判断 → 执行

---

## 底层逻辑

- **AI+IoT融合**：软件智能 + 硬件执行
- **系统工程**：多个模块协同工作
- **人机交互**：视觉反馈（RGB灯）+ 物理反馈（开门）

---

`#执行层` `#测评项`
[UID: PYAI-14-08-001]

---

[上一课](PYAI-1-4-07_智能门禁2.md) | [返回模块](_模块概览.md) | [下一课](PYAI-1-4-09_音强流水灯.md)
