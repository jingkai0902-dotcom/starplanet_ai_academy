# [PYAI-1-4-07] 智能门禁(2) - 人脸比对算法

> **模块**：L1-M4 智能硬件
> **认知负荷**：高
> **核心技能**：灰度处理cvtColor、特征匹配matchTemplate
> **UID**：PYAI-14-07-001

---

## 课程基本信息

| 项目 | 内容 |
|------|------|
| **课程编号** | PYAI-1-4-07 |
| **课程名称** | 智能门禁(2) - 人脸比对算法 |
| **认知负荷** | 高 |
| **核心技能** | 灰度处理cvtColor、特征匹配matchTemplate |
| **课时** | 90分钟 |
| **系列** | 智能门禁三部曲（2/3） |

---

## 详细教学流程

### 步骤1：课程回顾（5分钟）

`#低负荷-热身` `#IFC-预防`

**教师话术**
> "上节课我们学会了用摄像头拍照。今天我们要让电脑'认识'人脸——通过比对算法判断是不是同一个人！"

---

### 步骤2：知识讲解（15分钟）

`#中负荷-操练` `#IFC-即时`

**教师话术**
> "人脸比对的步骤是：
>
> **1. 灰度处理**：把彩色图变成黑白图，减少计算量
> ```python
> import cv2
>
> # 读取彩色图像
> color_img = cv2.imread('photo.jpg')
>
> # 转换为灰度图
> gray = cv2.cvtColor(color_img, cv2.COLOR_BGR2GRAY)
> ```
>
> **为什么要灰度？**
> - 彩色图有3个通道（BGR），灰度图只有1个通道
> - 计算量减少到1/3
> - 人脸特征主要靠轮廓，不需要颜色信息
>
> **2. 特征匹配**：把当前人脸和保存的人脸对比
> ```python
> # 模板匹配
> result = cv2.matchTemplate(gray, template, cv2.TM_CCOEFF_NORMED)
>
> # 获取最大相似度
> min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(result)
> similarity = max_val  # 相似度（0-1）
> ```
>
> **相似度判断**：
> - 0.8以上：很可能是同一个人
> - 0.6-0.8：可能是同一个人
> - 0.6以下：不是同一个人"

**核心代码模式**

```python
import cv2

def compare_faces(img1_path, img2_path):
    """比较两张人脸图片的相似度"""
    # 读取图片
    img1 = cv2.imread(img1_path, cv2.IMREAD_GRAYSCALE)
    img2 = cv2.imread(img2_path, cv2.IMREAD_GRAYSCALE)

    # 调整大小（确保尺寸一致）
    img1 = cv2.resize(img1, (100, 100))
    img2 = cv2.resize(img2, (100, 100))

    # 模板匹配
    result = cv2.matchTemplate(img1, img2, cv2.TM_CCOEFF_NORMED)

    # 获取相似度
    similarity = result[0][0]

    return similarity

# 使用示例
sim = compare_faces('face1.jpg', 'face2.jpg')
print(f'相似度: {sim:.2f}')

if sim > 0.8:
    print('匹配成功！是同一个人')
else:
    print('匹配失败！不是同一个人')
```

**变体示例**

| 学生情况 | 调整方案 | 说明 |
|----------|----------|------|
| 不理解灰度 | 用黑白照片类比 | "灰度就像老照片，只有黑白" |
| 匹配不准 | 调整阈值 | "相似度0.8以上才算匹配成功" |
| 想识别多人 | 引导使用列表 | 保存多个人脸模板 |

---

### 步骤3：实践准备（20分钟）

`#高负荷-产出` `#IFC-即时`

**教师话术**
> "现在我们来准备人脸模板：
>
> **步骤1**：拍摄自己的人脸照片
> ```python
> import cv2
>
> cap = cv2.VideoCapture(0)
> ret, frame = cap.read()
>
> # 保存为模板
> cv2.imwrite('my_face.jpg', frame)
> cap.release()
> ```
>
> **步骤2**：裁剪人脸区域（可选）
> ```python
> # 手动裁剪人脸区域
> face_region = frame[100:300, 150:350]  # [y1:y2, x1:x2]
> cv2.imwrite('my_face_crop.jpg', face_region)
> ```
>
> **注意**：拍照时保持正面、光线充足、表情自然"

---

### 步骤4：编程调试（30分钟）

`#高负荷-产出` `#IFC-即时`

**教师话术**
> "现在实现实时人脸比对：
>
> ```python
> import cv2
>
> # 加载人脸模板
> template = cv2.imread('my_face.jpg', cv2.IMREAD_GRAYSCALE)
> template = cv2.resize(template, (100, 100))
>
> cap = cv2.VideoCapture(0)
>
> while True:
>     ret, frame = cap.read()
>     if not ret:
>         break
>
>     # 转灰度
>     gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
>     gray_resized = cv2.resize(gray, (100, 100))
>
>     # 计算相似度
>     result = cv2.matchTemplate(gray_resized, template, cv2.TM_CCOEFF_NORMED)
>     similarity = result[0][0]
>
>     # 显示结果
>     if similarity > 0.6:
>         text = f'Match! {similarity:.2f}'
>         color = (0, 255, 0)  # 绿色
>     else:
>         text = f'No Match {similarity:.2f}'
>         color = (0, 0, 255)  # 红色
>
>     cv2.putText(frame, text, (10, 30),
>                 cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)
>     cv2.imshow('Face Recognition', frame)
>
>     if cv2.waitKey(1) & 0xFF == ord('q'):
>         break
>
> cap.release()
> cv2.destroyAllWindows()
> ```"

**变体示例**

| 学生情况 | 调整方案 | 说明 |
|----------|----------|------|
| 相似度一直很低 | 重新拍模板 | 确保光线和角度一致 |
| 想提高准确率 | 使用人脸检测 | 先检测人脸再比对 |
| 想加声音提示 | 导入winsound | 匹配成功时播放声音 |

---

### 步骤5：成果展示（10分钟）

`#低负荷-热身` `#IFC-复盘`

**教师话术**
> "谁的人脸比对做好了？试试看能不能识别出自己！
>
> 下节课我们将把AI和硬件连接起来——刷脸开门！"

---

## 核心知识点

- 灰度处理：`cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)`
- 模板匹配：`cv2.matchTemplate(img, template, method)`
- 相似度获取：`cv2.minMaxLoc(result)` 返回最大值
- 阈值判断：相似度 > 0.8 认为匹配成功

---

## 底层逻辑

- **图像预处理**：灰度化减少计算量
- **特征匹配**：计算两张图的相似程度
- **阈值决策**：根据相似度做出判断

---

`#执行层` `#测评项`
[UID: PYAI-14-07-001]

---

[上一课](PYAI-1-4-06_智能门禁1.md) | [返回模块](_模块概览.md) | [下一课](PYAI-1-4-08_智能门禁3.md)
