# 计算机视觉

> **用途**：OpenCV和图像处理在各课程中的应用详解
> **更新日期**：2026-02-10
> **数据来源**：萃取报告/PythonAI/

---

## 一、OpenCV基础

### 1.1 库简介

OpenCV (Open Source Computer Vision Library) 是最流行的计算机视觉库，支持图像处理、视频分析、物体检测等功能。

### 1.2 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 1-4-6 | 智能门禁(1) | 摄像头采集 |
| PYAI 2-4-1 | 视频基础 | VideoCapture |
| PYAI 2-4-3 | 图像编辑1 | 像素操作 |

### 1.3 安装

```bash
pip install opencv-python
```

### 1.4 基本结构

```python
import cv2
import numpy as np

# 图像是NumPy数组
# 形状: (高度, 宽度, 通道数)
# 通道顺序: BGR（不是RGB！）
```

---

## 二、摄像头操作

### 2.1 打开摄像头

```python
import cv2

# 打开默认摄像头（索引0）
cap = cv2.VideoCapture(0)

# 检查是否成功打开
if not cap.isOpened():
    print("无法打开摄像头")
    exit()

while True:
    # 读取一帧
    ret, frame = cap.read()
    if not ret:
        print("无法读取帧")
        break

    # 显示画面
    cv2.imshow('Camera', frame)

    # 按q退出
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# 释放资源（重要！）
cap.release()
cv2.destroyAllWindows()
```

### 2.2 设置摄像头参数

```python
# 设置分辨率
cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)

# 获取帧率
fps = cap.get(cv2.CAP_PROP_FPS)
```

### 2.3 禁忌提醒

| 禁忌 | 后果 | 正确做法 |
|------|------|---------|
| ❌ 忘记释放摄像头 | 下次无法使用 | 程序结束前调用`cap.release()` |
| ❌ 不检查ret返回值 | 程序崩溃 | 始终检查`if not ret: break` |

---

## 三、图像读写

### 3.1 读取图像

```python
import cv2

# 读取彩色图像
img = cv2.imread('image.jpg')

# 读取灰度图像
gray = cv2.imread('image.jpg', cv2.IMREAD_GRAYSCALE)

# 检查是否成功读取
if img is None:
    print("无法读取图像")
```

### 3.2 保存图像

```python
# 保存图像
cv2.imwrite('output.jpg', img)

# 指定质量（JPEG）
cv2.imwrite('output.jpg', img, [cv2.IMWRITE_JPEG_QUALITY, 90])
```

### 3.3 显示图像

```python
# 显示图像
cv2.imshow('Window Name', img)
cv2.waitKey(0)  # 等待按键
cv2.destroyAllWindows()
```

---

## 四、颜色空间转换

### 4.1 BGR与RGB

```python
# OpenCV使用BGR，其他库（如matplotlib）使用RGB
# BGR → RGB
rgb_img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)

# RGB → BGR
bgr_img = cv2.cvtColor(rgb_img, cv2.COLOR_RGB2BGR)
```

### 4.2 灰度转换

```python
# 彩色 → 灰度
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
```

### 4.3 HSV颜色空间

```python
# BGR → HSV（用于颜色检测）
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# HSV范围
# H: 0-179（色调）
# S: 0-255（饱和度）
# V: 0-255（明度）
```

### 4.4 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 2-3-1 | 眼控开关 | BGR→RGB转换 |
| PYAI 2-4-3 | 图像编辑1 | 灰度转换 |

---

## 五、图像绘制

### 5.1 基本绘制函数

```python
import cv2
import numpy as np

# 创建空白图像
img = np.zeros((400, 600, 3), dtype=np.uint8)

# 画线
cv2.line(img, (0, 0), (300, 200), (255, 0, 0), 2)
# 参数: 图像, 起点, 终点, 颜色(BGR), 线宽

# 画矩形
cv2.rectangle(img, (50, 50), (200, 150), (0, 255, 0), 2)
# 参数: 图像, 左上角, 右下角, 颜色, 线宽（-1为填充）

# 画圆
cv2.circle(img, (300, 200), 50, (0, 0, 255), -1)
# 参数: 图像, 圆心, 半径, 颜色, 线宽（-1为填充）

# 写文字
cv2.putText(img, 'Hello OpenCV', (50, 300),
            cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)
# 参数: 图像, 文字, 位置, 字体, 大小, 颜色, 线宽
```

### 5.2 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 2-3-9 | 手势绘画板 | 绘制轨迹 |
| PYAI 2-4-10 | 虚拟墨镜 | 绘制装饰 |

---

## 六、像素操作

### 6.1 访问像素

```python
# 获取像素值（BGR）
pixel = img[100, 200]  # [B, G, R]
b, g, r = img[100, 200]

# 设置像素值
img[100, 200] = [255, 255, 255]  # 白色
```

### 6.2 ROI（感兴趣区域）

```python
# 提取ROI
roi = img[50:150, 100:200]  # [y1:y2, x1:x2]

# 替换ROI
img[50:150, 100:200] = another_img
```

### 6.3 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 2-4-3 | 图像编辑1 | 像素操作 |
| PYAI 2-4-4 | 图像编辑2 | ROI替换 |

---

## 七、图像处理

### 7.1 调整大小

```python
# 调整大小
resized = cv2.resize(img, (300, 200))  # (宽, 高)

# 按比例缩放
resized = cv2.resize(img, None, fx=0.5, fy=0.5)
```

### 7.2 亮度调整

```python
# 增加亮度
bright = cv2.add(img, np.array([50, 50, 50]))

# 使用NumPy（注意溢出）
bright = np.clip(img.astype(np.int16) + 50, 0, 255).astype(np.uint8)
```

### 7.3 滤波降噪

```python
# 均值滤波
blur = cv2.blur(img, (5, 5))

# 高斯滤波（推荐）
blur = cv2.GaussianBlur(img, (5, 5), 0)

# 中值滤波（去除椒盐噪声）
blur = cv2.medianBlur(img, 5)
```

### 7.4 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 2-4-4 | 图像编辑2 | resize |
| PYAI 2-4-5 | 滤波降噪 | 三种滤波 |

---

## 八、二值化与阈值

### 8.1 简单阈值

```python
# 简单阈值
ret, binary = cv2.threshold(gray, 127, 255, cv2.THRESH_BINARY)
# 参数: 灰度图, 阈值, 最大值, 类型
```

### 8.2 自适应阈值

```python
# 自适应阈值（处理光照不均）
binary = cv2.adaptiveThreshold(gray, 255,
    cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv2.THRESH_BINARY, 11, 2)
```

### 8.3 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 2-4-6 | 文件扫描 | 二值化处理 |

---

## 九、人像分割

### 9.1 MediaPipe Selfie Segmentation

```python
import cv2
import mediapipe as mp

mp_selfie = mp.solutions.selfie_segmentation
selfie_seg = mp_selfie.SelfieSegmentation(model_selection=1)

cap = cv2.VideoCapture(0)

while True:
    ret, frame = cap.read()
    if not ret:
        break

    # 转换颜色空间
    rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    # 分割
    results = selfie_seg.process(rgb)

    # 获取掩膜
    mask = results.segmentation_mask
    mask = (mask > 0.5).astype(np.uint8) * 255

    # 应用掩膜
    fg = cv2.bitwise_and(frame, frame, mask=mask)

    cv2.imshow('Segmentation', fg)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
```

### 9.2 跨课程出现

| 课程编号 | 课程名称 | 具体内容 |
|----------|---------|---------|
| PYAI 2-4-8 | 人像分割 | 背景替换 |

---

## 十、常见错误与禁忌

| 错误 | 后果 | 正确做法 |
|------|------|---------|
| ❌ BGR/RGB混淆 | 颜色显示错误 | OpenCV用BGR，MediaPipe用RGB |
| ❌ 忘记释放资源 | 摄像头被占用 | 始终调用`cap.release()` |
| ❌ 不检查None | 程序崩溃 | 检查`img is None`和`ret` |
| ❌ 像素值溢出 | 颜色异常 | 使用`np.clip()`或`cv2.add()` |

---

## 十一、教学建议

### 11.1 认知进阶路线

```
PYAI 2-4-1          PYAI 2-4-3          PYAI 2-4-5          PYAI 2-4-8
摄像头基础   →      像素操作     →      滤波处理     →      人像分割
   ↓                   ↓                   ↓                   ↓
 VideoCapture        NumPy数组           卷积核              掩膜应用
```

### 11.2 常见教学难点

| 难点 | 解决方案 |
|------|---------|
| BGR顺序 | 用"蓝绿红"口诀记忆 |
| 坐标顺序 | 强调`img[y, x]`，先行后列 |
| 滤波原理 | 用"取平均"类比解释卷积 |

---

**维护者**：知识库管理员
**关联文件**：[AI知识总表.md](AI知识总表.md)、[人脸识别.md](人脸识别.md)
