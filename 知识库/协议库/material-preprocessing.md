# 素材预处理协议 V1.0

> 创建日期：2026-01-24
> 适用场景：将原始教学素材（PDF/Word/音视频）处理为可上传NotebookLM的扁平化文件

---

## 一、启动命令

```
启动素材预处理[级别]；路径：[文件夹路径]
```

**示例**：
```
启动素材预处理[G1]；路径：[C:\Users\Frank.J\Desktop\励步\新整理的材料\G1级别所有课堂材料最终版]
```

---

## 二、执行流程

### 步骤1：扫描与统计

```bash
# 统计文件总数
find "[路径]" -type f | wc -l

# 按类型统计
find "[路径]" -type f -name "*.pdf" | wc -l
find "[路径]" -type f -name "*.docx" | wc -l
find "[路径]" -type f -name "*.mp3" | wc -l
find "[路径]" -type f -name "*.mp4" | wc -l
```

**输出**：文件统计表

---

### 步骤2：查重（MD5哈希）

```bash
find "[路径]" -type f -exec md5sum {} \; | sort | uniq -D -w32
```

**处理规则**：
- 同一首歌在不同Session中重复 → 保留S1-Vocab中的，删除其他
- 期中/期末复习中的副本 → 删除
- 视频重复 → 保留第一个
- **共用音视频标注**：在索引文件中记录哪些Session共用同一音视频（便于萃取时关联）

**共用音视频记录格式**（在索引文件中）：
```markdown
## 共用音视频说明

| 保留文件 | 共用于 |
|---------|--------|
| G3A-U1-S1-Vocab/p14-Song.mp3 | U1-S1-Vocab, U1-S2-Reading |
| G3A-U3-S1-Vocab/P16-Song.mp3 | U3-S1-Vocab, U3-S2-Reading |
```

**确认后执行删除**：
```bash
rm "[重复文件路径]"
```

---

### 步骤3：清理垃圾文件

```bash
# 查找垃圾文件/目录
find "[路径]" -name "__MACOSX" -type d
find "[路径]" -name ".DS_Store" -type f
find "[路径]" -name "Thumbs.db" -type f
find "[路径]" -name "._*" -type f

# 删除
rm -rf "[垃圾目录]"
```

---

### 步骤4：音视频转录

**使用Whisper转录**，生成.md文件，格式如下：

```markdown
# 转录: [原文件名]

**原始文件**: `[相对路径]`

**检测语言**: en

---

## 转录内容

[完整转录文本]

---

## 时间戳分段

[0.0s - 3.5s] First sentence here.

[3.5s - 7.2s] Second sentence here.

...
```

**转录后立即删除原始音视频文件**。

---

### 步骤5：扁平化输出

**输出目录**：
```
C:\Users\Frank.J\Desktop\励步\新整理的材料\[级别]_upload\
```

**⚠️ 300文件限制**：单个输出文件夹内文件数量不得超过300个。若超过，需按以下规则分包：
- 分包命名：`[级别]_upload_part1`、`[级别]_upload_part2`...
- 每包生成独立的索引文件
- 按Unit顺序分包，避免将同一Unit拆分到不同包

**文件命名规则**：
```
[单元文件夹]_[Session文件夹]_[原文件名].[扩展名]
```

**示例**：
| 原始路径 | 扁平化文件名 |
|---------|-------------|
| G1A/G1A-unit1/G1A-U1-S1-Vocab/G1A-U1-S1-Vocab.pdf | G1A-unit1_G1A-U1-S1-Vocab_G1A-U1-S1-Vocab.pdf |
| G1A/G1A-unit1/G1A-U1-S2-reading/p10-story.mp3 | G1A-unit1_G1A-U1-S2-reading_p10-story.md |

---

### 步骤6：生成索引文件

**文件名**：`[级别]_INDEX.md`

**格式**：
```markdown
# [级别] 励步英语知识库索引

本索引包含[级别]级别的全部教学资源，共[N]个文件。

## 文件统计

| 类型 | 数量 | 说明 |
|------|------|------|
| PDF | [n] | 教学课件 |
| DOCX | [n] | 教师指南(Teaching Guide) |
| MD | [n] | 音视频转录文本 |

---

## 课程结构

[级别课程结构说明]

---

## 文件清单

### 教学文档 (PDF)

- [文件名1]
- [文件名2]
...

### 教师指南 (DOCX)

- [文件名1]
...

### 音视频转录 (MD)

- [文件名1]
...

---

## 共用音视频说明

> 以下音视频文件被多个Session共用，转录文件仅保留一份。萃取时请注意关联。

| 保留文件 | 共用于 |
|---------|--------|
| [保留的文件路径] | [Session1], [Session2], ... |
| ... | ... |
```

---

## 三、输出检查清单

| 检查项 | 命令 |
|--------|------|
| 原始目录无音视频 | `find "[原路径]" -name "*.mp3" -o -name "*.mp4"` |
| 输出目录文件数正确 | `ls "[输出目录]" \| wc -l` |
| 索引文件存在 | `ls "[输出目录]/[级别]_INDEX.md"` |
| 无重复文件 | `find "[输出目录]" -type f -exec md5sum {} \; \| sort \| uniq -d -w32` |

---

## 四、参考：G1处理结果

| 项目 | 数量 |
|------|------|
| 原始文件 | 335 |
| 删除重复 | -26 |
| 删除垃圾 | -1目录 |
| 清理后 | 308 |
| PDF | 73 |
| DOCX | 18 |
| MD (转录) | 154 |
| **最终输出** | **245** |

**输出目录**：`C:\Users\Frank.J\Desktop\励步\新整理的材料\G1_upload\`

---

## 五、脚本位置

```
C:\Users\Frank.J\libu_knowledge\scripts\
├── flatten_g1.py          # G1扁平化脚本（可参考修改用于其他级别）
├── flatten_remaining.py   # 补充处理期中期末
└── dehydrator.py          # 旧版脱水脚本（生成合并文档，非扁平化）
```

---

*协议版本：V1.0 | 更新日期：2026-01-24*
