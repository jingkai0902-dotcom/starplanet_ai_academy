# 7.1 分批萃取协议 (Batch Processing)

> 来源：知识库萃取标准与执行规则.md V3.5

## 强制分批规则

| 条件 | 执行方式 |
|------|---------|
| 来源数 ≤ 10 | 可一次性处理 |
| 来源数 > 10 | **必须执行"5-5循环原则"** |

## 5-5循环原则

- 每次仅加载**5个**来源内容
- 确保模型注意力集中，避免信息遗漏
- 防止单次输出文档过大
- 完成一批后再处理下一批

## 断点续传协议（强制执行）

> **核心原则：禁止全量重读，从上次最后Source ID继续**

### 断点记录要求

- 每批次完成后，AI**必须**记录已处理的最后一个Source ID
- 记录格式：`断点位置：来源 1-5 / 共 67 个 | 最后Source ID: K1-05`
- 断点信息必须写入本地萃取文件末尾

### 中断恢复规则

| 场景 | 处理方式 |
|------|---------|
| 网络中断 | 从最后记录的Source ID下一个开始 |
| 会话超时 | 读取本地断点记录，继续执行 |
| 主动暂停 | 记录断点后安全退出 |

### 禁止事项

- ❌ 禁止全量重读规则文档（仅在新会话首次读取）
- ❌ 禁止重新扫描已处理���来源
- ❌ 禁止从头开始萃取已完成的批次

### 断点记录模板

```markdown
---
## 断点记录（请勿删除）

**笔记本**：[笔记本名称]
**总来源数**：[数量]
**已完成批次**：[X]/[总批次]
**已处理来源**：[起始]-[结束]
**最后Source ID**：[ID]
**下次起始**：来源[N]（[ID]）
**记录时间**：[时间]
**状态**：暂停中

---
```

### 恢复执行话术

```
继续萃取任务：[笔记本名称]
从断点恢复：来源[N]-[M]（[ID]至[ID]）
请加载来源[N]-[M]的内容进行深度萃取。
```

## 扫描报告作为调度表（强制执行）

**在进入深度萃取前，AI必须基于"快速扫描报告"自动生成调度表：**

### 调度表生成规则

1. 读取扫描报告中每个笔记本的来源数量
2. 自动计算所需批次数：`批次数 = 向上取整(来源数 / 5)`
3. 估算Token消耗：`预估Token = 批次数 × 单批次平均Token`
4. 生成完整的执行计划供用户确认

### 调度表模板

```markdown
## 深度萃取调度表

**生成日期**：[日期]
**数据来源**：[扫描报告名称]

### 任务总览

| 笔记本名称 | 来源数 | 批次数 | 预估Token | 优先级 |
|-----------|--------|--------|-----------|--------|
| [名称] | [数量] | [X]批 | ~[数量] | P[N] |

### Token消耗预估说明

| 项目 | 数值 | 说明 |
|------|------|------|
| 单批次平均Token | ~2,500 | 包含输入+输出 |
| 总批次数 | [X]批 | 基于5-5原则 |
| 预估总Token | ~[数量] | 实际可能有±20%浮动 |
```

### Token预估参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 单批次输入Token | ~1,500 | 5个来源的平均内容量 |
| 单批次输出Token | ~1,000 | 结构化萃取的平均输出 |
| 单批次总Token | ~2,500 | 输入+输出 |
| 浮动范围 | ±20% | 内容复杂度差异 |

### 批次记录模板

```markdown
## 萃取进度记录

**笔记本名称**：[名称]
**来源总数**：[数量]
**批次规划**：[X] 批（每批5个）
**预估Token**：[数量]

| 批次 | 来源范围 | 状态 | 完成时间 | 实际Token | 断点ID |
|------|---------|------|---------|-----------|--------|
| 1 | 1-5 | ✅ 已完成 | [时间] | [数量] | [ID] |
| 2 | 6-10 | 🔄 进行中 | - | - | - |
| 3 | 11-15 | ⏳ 待处理 | - | - | - |
```

---
