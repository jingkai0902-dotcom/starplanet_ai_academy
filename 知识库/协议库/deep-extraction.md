# 深度萃取执行协议 V1.0

> 创建日期：2026-01-24
> 适用场景：执行"深度萃取：[级别] 笔记本：[URL]"命令

---

## 一、触发条件

当用户输入以下格式的命令时，**立即**执行本协议：

```
深度萃取：[级别]
笔记本：[NotebookLM URL]
```

---

## 二、执行流程（强制顺序）

### 步骤1：加载必要协议（必须）

```bash
# 1. 加载萃取规则
Read: 知识库/知识库萃取标准与执行规则.md

# 2. 加载分批处理协议
Read: 知识库/协议库/batch-processing.md
```

### 步骤2：调用NotebookLM Skill（必须）

**立即调用**，不要尝试WebFetch：

```bash
# 检查认证状态（注意编码问题）
cd "C:/Users/Frank.J/.claude/skills/notebooklm" && PYTHONIOENCODING=utf-8 python scripts/run.py auth_manager.py status 2>&1 | cat

# 如果未认证，执行setup
PYTHONIOENCODING=utf-8 python scripts/run.py auth_manager.py setup 2>&1 | cat
```

### 步骤3：查询索引文档（必须）

**在任何萃取之前，必须先查询索引文档**：

```bash
PYTHONIOENCODING=utf-8 python scripts/run.py ask_question.py \
  --question "请完整显示 [级别]_INDEX.md 的全部内容，包括所有文件清单" \
  --notebook-url "[URL]" 2>&1 | cat
```

### 步骤4：生成调度表（必须）

根据索引文档，生成5-5循环调度表：

```markdown
## 深度萃取调度表

**笔记本**：[名称]
**来源总数**：[N]
**批次规划**：[X]批（每批5个来源）

| 批次 | 来源范围 | 文件名示例 | 状态 |
|------|---------|-----------|------|
| 1 | 1-5 | [文件1], [文件2]... | ⏳ 待处理 |
| 2 | 6-10 | ... | ⏳ 待处理 |
...
```

### 步骤5：执行5-5循环萃取

**每批次执行**：

```bash
PYTHONIOENCODING=utf-8 python scripts/run.py ask_question.py \
  --question "[萃取提问模板，指定5个具体文件名]" \
  --notebook-url "[URL]" 2>&1 | cat
```

**萃取提问模板**：
```
当前处理：[笔记本名称] 来源 [X-Y] / 共 [N] 个

请深度分析以下5个来源文件：
1. [文件名1]
2. [文件名2]
3. [文件名3]
4. [文件名4]
5. [文件名5]

执行多维扫描：
1. 话术逻辑：场景定义、标准话术、底层逻辑、变体示例、禁忌提醒
2. 动作逻辑：触发条件、动作序列、配套话术、检查清单、异常处理
3. 底层逻辑：完整框架、核心概念、可执行的逻辑模型
4. 规范逻辑：操作边界、执行细节、奖惩逻辑
5. 教学内容：词汇表、句型、教学流程、教学技巧

请按标准模板输出，打多态标签，生成UID。
```

### 步骤6：记录断点

每批次完成后，记录断点：

```markdown
---
## 断点记录

**笔记本**：[名称]
**已完成批次**：[X]/[总批次]
**已处理来源**：1-[N]
**最后Source ID**：[文件名]
**下次起始**：来源[N+1]
**记录时间**：[时间]
---
```

### 步骤7：处理萃取失败的文件

如果NotebookLM回复"内容缺失"或"文件不存在"：

1. **精确查询**：用完整文件名再次查询
   ```
   请完整显示文件 [精确文件名.pdf] 的所有内容，逐页列出。
   ```

2. **如果仍失败**：
   - 记录失败文件名
   - 提示用户检查NotebookLM中该文件是否正确上传
   - 建议用户重新上传该文件

3. **继续萃取**：不要因为个别文件失败而停止整体流程

---

## 三、编码问题解决方案（Windows必须）

### 问题
Windows默认GBK编码与Python UTF-8输出冲突

### 解决方案
**所有NotebookLM脚本调用必须使用以下格式**：

```bash
PYTHONIOENCODING=utf-8 python scripts/run.py [脚本] [参数] 2>&1 | cat
```

### 禁止
```bash
# ❌ 错误：直接调用
python scripts/run.py auth_manager.py status

# ❌ 错误：使用chcp（bash不支持）
chcp 65001 && python scripts/run.py ...
```

---

## 四、禁止事项

| 禁止行为 | 正确做法 |
|---------|---------|
| ❌ 用WebFetch访问NotebookLM URL | ✅ 直接调用NotebookLM skill |
| ❌ 跳过索引文档查询 | ✅ 必须先查询INDEX文件 |
| ❌ 一次萃取超过5个来源 | ✅ 严格5-5循环 |
| ❌ 按单元萃取（可能超过5个文件） | ✅ 按文件数量分批 |
| ❌ 萃取失败后停止 | ✅ 记录失败文件，继续其他 |
| ❌ 不记录断点 | ✅ 每批次必须记录断点 |

---

## 五、检查清单

执行深度萃取前，确认以下事项：

- [ ] 已加载萃取规则文档
- [ ] 已加载batch-processing.md协议
- [ ] 已检查NotebookLM认证状态
- [ ] 已查询并阅读INDEX索引文档
- [ ] 已生成5-5循环调度表
- [ ] 已确认编码设置（PYTHONIOENCODING=utf-8）

---

## 六、示例执行流程

```
用户：深度萃取：G1
     笔记本：https://notebooklm.google.com/notebook/xxx

Claude：
1. [加载萃取规则] ✅
2. [加载batch-processing.md] ✅
3. [检查NotebookLM认证] ✅ 已认证
4. [查询G1_INDEX.md] → 获取245个来源列表
5. [生成调度表] → 49批次（每批5个）
6. [开始第1批] → 来源1-5
7. [记录断点] → 已完成1/49批
8. [继续第2批] → 来源6-10
...
```

---

## 八、NotebookLM回复不完整的应对策略（新增）

### 问题描述
NotebookLM经常出现以下问题：
1. 回复内容跑题，返回其他批次的内容
2. 回复不完整，遗漏部分来源
3. 不按要求的格式输出

### 解决方案

#### 策略1：分批更细（每次3个来源）
当来源数量较多时，将5-5循环改为3-3循环：
```
原则：来源数 > 50 时，每批处理3个来源
```

#### 策略2：指定具体文件名
在提问中明确列出要处理的文件名���而非仅用编号：
```
❌ 错误：请萃取来源101-105
✅ 正确：请萃取以下5个文件：
1. [完整文件名1]
2. [完整文件名2]
...
```

#### 策略3：单文件深挖
对于重要文件，单独查询：
```
请完整显示文件 [精确文件名] 的所有内容，逐字输出，不要概括。
```

#### 策略4：验证性追问
每批萃取后，追问确认：
```
刚才的回复是否完整覆盖了来源[X-Y]的所有内容？如有遗漏请补充。
```

#### 策略5：断点细化
记录每个文件的处理状态，而非仅记录批次：
```markdown
| 来源编号 | 文件名 | 状态 | 萃取时间 |
|---------|--------|------|---------|
| 117 | xxx.md | ✅ | 2026-01-27 |
| 118 | xxx.md | ⏳ | - |
```

### 执行检查清单
- [ ] 每批次是否指定了具体文件名？
- [ ] 回复是否覆盖了所有指定文件？
- [ ] 是否进行了验证性追问？
- [ ] 是否记录了每个文件的处理状态？

---

*策略版本：V1.1 | 更新日期：2026-01-27*
